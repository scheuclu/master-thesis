\documentclass[../main.tex]{subfiles}
%\usepackage{algorithm}
%\usepackage{algorithmic}


\everymath{\displaystyle}
\def\arraystretch{2.0}
\begin{document}
\setlength{\delimitershortfall}{0pt}

\section{Verification}\label{sec:verification}
After chapter~\ref{sec:fluid_mechanics} described the basic equation of fluid mechanics, discretization of this equations with \ac{FV} and \ac{FE} schemes in section~\ref{sec:finite_volume_method}, and an introduction to \ac{SA}, the expressions for the actual derivatives have been derived in section~\ref{sec:SA}. This has been done for both the body-fitted and the embedded~\ref{sec:fiver} framework of AERO-F.\\
This section is denoted to a thorough validation of the obtained derivatives. As described in REF, AERO-F handles both sensitivities with respect to far-field variables(e.g. angle of attack) as well as shape sensitivities. Both types require to be handled fundamentally differently. While the first type leads to derivatives mainly in the far field boundary conditions, the latter one interferes with the wall treatment. More importantly, as shown in section TODO, in the embedded case, doing shape sensitivities leads to addtitional derivatives with regards to the intersector.\\
For all those reasons, the verification provided in this chapter deals with both $\machnum_{\infty}$-sensitivity as well as shape-sensitivity. More over we will provide plots for both the body-fitted and the embedded case.

\subsection{Verification approach}\label{sec:verification_approach}
The question of how to verify the obtained sensitivities is cumbersome anything but straightforward.\\
To begin with, what quantity can we verify anyway?\\
If we have a look at equation \textbf{TODO}, one can see, that there are to main derivatives: $\pdfrac{\dresidual}{\dfstate}$ and $\pdfrac{\dresidual}{\dfstate}$.\\
The basic idea that we exploit for verification is to compute a reference solution for the Sensitivities by a \ac{FD} of two steady-state simulation. The advantage is, that the sensitivity-module does not have to be used at all to obtain those references, thus it is ensured that potential bugs are not carried over.\\
However, for both of the above quantities, computing a finite difference solution is cumbersome. For the Jacobian $\pdfrac{\dresidual}{\dfstate}$ a simple forward difference would look as follows:
\begin{align}
\pdfrac{\dresidual_i}{\dfstate_j}\bigg\rvert_{\fstate_0}=\frac{\dresidual_i(\dfstate_o)+\epsilon\vec{e}_j)-\dresidual_i(\dfstate_o)-\epsilon\vec{e}_j)}{2\epsilon}
\end{align}
which would entail an $\order(N)$ number of residual evaluations.\\
As far as $\pdfrac{\dresidual}{\dfstate}$ goes, a \ac{FD} verification would be feasible:
\begin{align}
\pdfrac{\dresidual_i}{\machnum_{\infty}}&=\frac{\dresidual(\dfstate_i^{+})-\dresidual(\dfstate_i^{-})}{2\epsilon} \nonumber \\
\dfstate_i^{\pm} &=
\begin{cases}
\dfstate_i\big\rvert_{0}\text{   for internal nodes}\\
\dfstate_i\big\rvert_{\fstate_i(\machnum_i=\machnum_0+\epsilon)}\text{   for boundary nodes}
\end{cases}
\end{align}
which could be done cheaply, and is in fact done in AERO-F if the parameter \texttt{SensitivityAnalysis.SensitivityComputation} is set to \texttt{FiniteDifference} however, it requires the fluid-state to be updated according to the mach-number change at the fluid boundary and thus introduced the potential for new bugs.\\
Instead, the first quantity to be validated in this thesis is the solution of the linear system described in equation \textbf{REF}, $\pdfrac{\dfstate}{\absvar}$.\\
this can be done easily by performing a simple \ac{FD} difference on the solution of two steady-state simulations;
\begin{align}
\tfrac{\dfstate}{\absvar}=\frac{\dfstate(\absvar+\epsilon)-\dfstate(\absvar-\epsilon)}{2 \epsilon}
\end{align}
which involves no extra coding and can be done with a standard steady state solver.\\

Additionally, since the optimization will run on lift and drag, we also validate them with steady state results.
\begin{align}
\tfrac{\optcrit}{\absvar}=\frac{\optcrit(\absvar+\epsilon)-\optcrit(\absvar-\epsilon)}{2 \epsilon}
\end{align}



\section{Verification of mach-sensitivity}
The verification of $\tfrac{\dfstate}{\machnum_{\infty}}$ for ALE simulations is provided in figure~\ref{fig:verification_dwdma_ale_Euler} for Euler equation, figure~\ref{fig:verification_dwdma_ale_Laminar} for full \ac{NSE} and in figure~\ref{fig:verification_dwdma_ale_RANS} for \ac{NSE} equations with an additional Spallart-Almares turbulence model.
Additionally, a side by side comparison of the analytic results between all three equation types is also provided in figure~\ref{fig:verification_dwdma_ale_comparison} in order to ensure that the additional viscous and turbulent terms actually account for a visible difference.\\
For the embedded case, we provide the verification of $\tfrac{\dfstate}{\machnum_{\infty}}$  in figure~\ref{fig:verification_dwdma_emb_Euler} for Euler equation, figure~\ref{fig:verification_dwdma_emb_Laminar} for full \ac{NSE} and in figure~\ref{fig:verification_dwdma_emb_RANS} for \ac{NSE} equations with an additional Spallart-Almares turbulence model.
Again, a side by side comparison of the analytic results between all three equation types is also provided in figure~\ref{fig:verification_dwdma_emb_comparison} in order to ensure that the additional viscous and turbulent terms actually account for a visible difference.


%--------------------------------------------------------------------------------------------
%\subsection{Body-fitted}
\foreach \vertype in {Euler,Laminar,RANS}{
	%\subsubsection{Verification $\tfrac{\dfstate}{\machnum_{\infty}}$ for \vertype equations and a body-fitted framework}
	\begin{figure}[t!]
	    \centering
	    \textbf{Verification $\tfrac{\dfstate}{\machnum_{\infty}}$ for {\vertype} equations and a body-fitted framework}\par\medskip    
	    \foreach \n in {1,2,3,4,5}{
	      \foreach \type in {FD,ana}{
			    \begin{subfigure}[t]{0.5\textwidth}
			        \centering
			        \includegraphics[width=\linewidth]{\mainpath/fig/studies/StateVector_verification/machsens/ALE/\vertype_component\n_\type}
			        \caption{$\d{w}_\n^{\type}$}
			    \end{subfigure}%
			    ~ 
	      }
	      
	    }
	    \caption[aaa]{aaa}
	    \label{fig:verification_dwdma_ale_\vertype}
	    
	    
	\end{figure}
}
\if \n==5
asdasdasdasd
\fi
%--------------------------------------------------------------------------------------------
%\subsection{Embedded}
\foreach \vertype in {Euler,Laminar,RANS}{
	%\subsubsection{Verification of the \vertype derivatives}
	\begin{figure}[t!]
	    \centering
	    \textbf{Verification $\tfrac{\dfstate}{\machnum_{\infty}}$ for {\vertype} equations and a embedded framework}\par\medskip    
	    \foreach \n in {1,2,3,4,5}{
	      \foreach \type in {ana,FD}{
			    \begin{subfigure}[t]{0.5\textwidth}
			        \centering
			        \includegraphics[width=\linewidth]{\mainpath/fig/studies/StateVector_verification/machsens/Emb/\vertype_component\n_\type}
			        \caption{$\d{w}_\n^{\type}$}
			    \end{subfigure}%
			    ~ 
	      }
	      
	    }
	    \caption[aaa]{aaa}
	    \label{fig:verification_dwdma_emb_\vertype}
	    
	\end{figure}
}


%--------------------------------------------------------------------------------------------
%\subsubsection{Comparison}
\begin{figure}[t!]
    \centering
    \textbf{Comparison of $\tfrac{\dfstate}{\machnum_{\infty}}$ in the embedded framework for all 3 equation types}\par\medskip    
    \foreach \n in {1,2,3,4,5}{
      \foreach \simtype in {Euler,Laminar,RANS}{
		    \begin{subfigure}[t]{0.33\textwidth}
		        \centering
		        \includegraphics[width=\linewidth]{\mainpath/fig/studies/StateVector_verification/machsens/Emb/\simtype_component\n_ana}
		        \caption{$\d{w}_\n^{\type}$}
		    \end{subfigure}%
		    ~ 
      }
      
    }
    \caption[aaa]{aaa}
    \label{fig:verification_dwdma_emb_comparison}
\end{figure}



%--------------------------------------------------------------------------------------------
%--------------------------------------------------------------------------------------------


\section{Verification shape sensitivity}
The verification of $\tfrac{\dfstate}{\absvar}$ for ALE simulations is provided in figure~\ref{fig:verification_dwdma_ale_Euler} for Euler equation, figure~\ref{fig:verification_dwdma_ale_Laminar} for full \ac{NSE} and in figure~\ref{fig:verification_dwdma_ale_RANS} for \ac{NSE} equations with an additional Spallart-Almares turbulence model.
Additionally, a side by side comparison of the analytic results between all three equation types is also provided in figure~\ref{fig:verification_dwdma_ale_comparison} in order to ensure that the additional viscous and turbulent terms actually account for a visible difference.
\\
For the embedded case, we provide the verification of $\tfrac{\dfstate}{\absvar}$  in figure~\ref{fig:verification_dwdma_emb_Euler} for Euler equation, figure~\ref{fig:verification_dwdma_emb_Laminar} for full \ac{NSE} and in figure~\ref{fig:verification_dwdma_emb_RANS} for \ac{NSE} equations with an additional Spallart-Almares turbulence model.
Again, a side by side comparison of the analytic results between all three equation types is also provided in figure~\ref{fig:verification_dwdma_emb_comparison} in order to ensure that the additional viscous and turbulent terms actually account for a visible difference.
%--------------------------------------------------------------------------------------------
%\subsection{Body-fitted}
\foreach \vertype in {Euler,Laminar,RANS}{
	%\subsubsection{Verification of the \vertype derivatives}
	\begin{figure}[t!]
	    \centering
	    \textbf{Verification $\tfrac{\dfstate}{\absvar}$ for {\vertype} equations and a body-fitted framework}\par\medskip    
	    \foreach \n in {1,2,3,4,5}{
	      \foreach \type in {ana,FD}{
			    \begin{subfigure}[t]{0.5\textwidth}
			        \centering
			        \includegraphics[width=\linewidth]{\mainpath/fig/studies/StateVector_verification/shapesens/ALE/\vertype_component\n_\type}
			        \caption{$\d{w}_\n^{\type}$}
			    \end{subfigure}%
			    ~ 
	      }
	      
	    }
	    \caption[aaa]{aaa}
	    \label{fig:verification_dwdma_ale_\vertype}
	    
	\end{figure}
}

%--------------------------------------------------------------------------------------------
%\subsection{Embededd}

\foreach \vertype in {Euler,Laminar,RANS}{
	%\subsubsection{Verification of the \vertype derivatives}
	\begin{figure}[t!]
	    \centering
	    \textbf{Verification $\tfrac{\dfstate}{\absvar}$ for {\vertype} equations and a embedded framework}\par\medskip    
	    \foreach \n in {1,2,3,4,5}{
	      \foreach \type in {ana,FD}{
			    \begin{subfigure}[t]{0.5\textwidth}
			        \centering
			        \includegraphics[width=\linewidth]{\mainpath/fig/studies/StateVector_verification/shapesens/Emb/\vertype_component\n_\type}
			        \caption{$\d{w}_\n^{\type}$}
			    \end{subfigure}%
			    ~ 
	      }
	      
	    }
	    \caption[aaa]{aaa}
	    \label{fig:verification_dwdma_emb_\vertype}
	    
	\end{figure}
}


%--------------------------------------------------------------------------------------------
%\subsubsection{Comparison}
\begin{figure}[t!]
    \centering
    \textbf{Comparison of $\tfrac{\dfstate}{\machnum_{\infty}}$ in the embedded framework for all 3 equation types}\par\medskip    
    \foreach \n in {1,2,3,4,5}{
      \foreach \simtype in {Euler,Laminar,RANS}{
		    \begin{subfigure}[t]{0.33\textwidth}
		        \centering
		        \includegraphics[width=\linewidth]{\mainpath/fig/studies/StateVector_verification/shapesens/Emb/\simtype_component\n_ana}
		        \caption{$\d{w}_\n^{\type}$}
		    \end{subfigure}%
		    ~ 
      }
      
    }
    \caption[aaa]{aaa}
    \label{fig:verification_dwdma_emb_comparison}
\end{figure}






\end{document}





