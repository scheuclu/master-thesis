\section{Sensitivity Analysis}

\def\incrabsvars{\Delta \absvars}
\def\incrlagmultsneq{\Delta \lagmultsneq}
\def\incrlagmultseq{\Delta \lagmultseq}

\def\PPLagfuncBYabsvars{\ppdfrac{\Lagfunc}{\absvars}}
\def\PLagfuncBYabsvars{\pdfrac{\Lagfunc}{\absvars}}
\def\PneqctrBYabsvars{\pdfrac{\neqctr}{\absvar}}
\def\PeqctrBYabsvars{\pdfrac{\eqctr}{\absvar}}

\def\DoptcritJBYabsvarI{\frac{d \optcrit_{j}}{d \absvar_{i}}}
\def\PoptcritJBYabsvarI{\pdfrac{\optcrit_{j}}{\absvar_{i}}}

\def\PoptcritJBYstructdisp{\pdfrac{\optcrit_{j}}{\structdisp}}
\def\PoptcritJBYmms       {\pdfrac{\optcrit_{j}}{\mms}}
\def\PoptcritJBYfstate    {\pdfrac{\optcrit_{j}}{\dfstate}}

\def\DoptcritJBYstructdisp{\tfrac{\optcrit_{j}}{\structdisp}}
\def\DoptcritJBYmms       {\tfrac{\optcrit_{j}}{\mms}}
\def\DoptcritJBYfstate    {\tfrac{\optcrit_{j}}{\dfstate}}

\def\DstructdispBYabsvarI{\frac{d \structdisp}{d \absvar_{i}} }
\def\DmmsBYabsvarI       {\frac{d \mms       }{d \absvar_{i}} }
\def\DfstateBYabsvarI    {\frac{d \dfstate    }{d \absvar_{i}} }

\def\PstructdispBYabsvarI{\pdfrac{d \structdisp}{d \absvar_{i}} }
\def\PmmsBYabsvarI       {\pdfrac{d \mms       }{d \absvar_{i}} }
\def\PfstateBYabsvarI    {\pdfrac{d \dfstate    }{d \absvar_{i}} }

\def\PEOSstructBYabsvarI{\pdfrac{\EOSstruct} {\absvar_i}}
\def\PEOSmeshBYabsvarI  {\pdfrac{\EOSmesh}  {\absvar_i}}
   %\def\PEOSfluidBYabsvarI{\pdfrac{\EOSfluid}{\absvar_i}}

\def\DEOSstructBYabsvarI{\tfrac{\EOSstruct} {\absvar_i}}
\def\DEOSmeshBYabsvarI  {\tfrac{\EOSmesh}  {\absvar_i}}
  %\def\DEOSfluidBYabsvarI{\tfrac{\EOSfluid}{\absvar_i}}

\def\PEOSstructBYstructdisp{\pdfrac{\EOSstruct} {\structdisp}}
\def\PEOSstructBYmms{\pdfrac{\EOSstruct}{\mms}}
\def\PEOSstructBYfstate    {\pdfrac{\EOSstruct}{\dfstate}}

\def\PEOSmeshBYstructdisp{\pdfrac{\EOSmesh}{\structdisp}}
\def\PEOSmeshBYmms       {\pdfrac{\EOSmesh} {\mms}}
\def\PEOSmeshBYfstate    {\vec{0}}

\def\PEOSfluidBYstructdisp{\vec{0}}
   %\def\PEOSfluidBYmms       {\pdfrac{\EOSfluid} {\mms}}
   %\def\PEOSfluidBYfstate    {\pdfrac{\EOSfluid} {\fstate}}

\def\PstructdispBYabsvarI{\pdfrac{\structdisp} {\absvar_i}}
\def\PmmsBYabsvarI       {\pdfrac{\mms}        {\absvar_i}}
\def\PfstateBYabsvarI    {\pdfrac{\fstate}     {\absvar_i}}

%------------------------------------------------------------------------------

\begin{frame}
  \frametitle{Computation of the gradient}

  \begin{itemize}
    \item{Objective}
      \begin{equation*}
        \begin{aligned}
          & \underset{\dfstate \in \Rbb^{N_\wbold},~\absvar \in \Rbb^{N_\absvar}}{\text{minimize}}
          & & \optcrit(\absvar, \dfstate, \mpos)
        \end{aligned}
      \end{equation*}  
    \item Gradients of the objective function
			\begin{align*}\label{eq:sensitivity_startingpoint}
			\DoptcritJBYabsvarI\bigg\rvert_{\fstate_0}=\setulcolor{primary_0}\setul{}{2pt}
			\only<1->{\underbrace{\PoptcritJBYabsvarI\bigg\rvert_{\dfstate_0}}_{
			                                                        \substack{
			                                                                 \text{\ul{directly derived from}} \\
			                                                                 \text{\ul{the definition of} $\optcrit$}
			                                                                 } 
			                                                        }}  +
			\only<2->{\underbrace{\PoptcritJBYfstate\bigg\rvert_{\dfstate_0}}_ {\setulcolor{neutral_1}
			                                                        \substack{
			                                                                 \text{\ul{derived analytically or~~}}\\
			                                                                 \text{\ul{by} FD}
			                                                                 }
			                                                        }    }                                         
			\only<3-5>{\underbrace{\hle{white}{\DfstateBYabsvarI\bigg\rvert_{\dfstate_0}}}_  {\setulcolor{neutral_2}
			                                                        \substack{
			                                                                 \text{\ul{derived from dynamic}}\\
			                                                                 \text{\ul{fluid equilibrium}}
			                                                                 }
			                                                        } + \\}
			\only<6->{\underbrace{\hle{neutral_1}{\DfstateBYabsvarI\bigg\rvert_{\dfstate_0}}}_  {\setulcolor{neutral_2}
			                                                        \substack{
			                                                                 \text{\ul{derived from dynamic}}\\
			                                                                 \text{\ul{fluid equilibrium}}
			                                                                 }
			                                                        } + \\}
			\only<4->{\underbrace{
			  \only<4->{\underbrace{\pdfrac{\optcrit}{\dmpos}\bigg\rvert_{\dfstate_0}}_ {\setulcolor{neutral_1}
			                                                        \substack{
			                                                                 \text{\ul{derived analytically or~~}}\\
			                                                                 \text{\ul{by} FD}
			                                                                 }
			                                                        }}
			  \only<5->{\underbrace{\tfrac{\dmpos}{\absvar_i}\bigg\rvert_{\dfstate_0}}_  {\setulcolor{neutral_2}
			                                                        \substack{
			                                                                 \text{\ul{derived from SDESIGN}}\\
			                                                                 \text{\ul{~}}
			                                                                 }
			                                                        }}
		   }_{=0\text{ for Embedded}}}
			\end{align*}
  \end{itemize}
  \onslide<6->{\hlt{neutral_1}{\textbf{$\rightarrow$ We only look into this term}!}}
\end{frame}

%------------------------------------------------------------------------------



%------------------------------------------------------------------------------


\begin{frame}
\frametitle{Sensitivity derivation - chain rule}
\framesubtitle{$\pdfrac{\optcrit}{\absvar}$}
\centering
\begin{tikzpicture}[node distance = 0.6cm, auto]
        \def\hdist{0.7cm}
        \node [blockb]                                      (l11) {$\pdfrac{\optcrit}{\absvar}$};
        \node [below of = l11]                              (l11o) {};
        
        %level-2
        \node [blocka, below of=l11o]                      (l23) {$\pdfrac{\optcrit_j}{\absvar_i}$};
        \node [blocka, left =\hdist of l23]               (l22) {$\pdfrac{\optcrit_j}{\dfstate}$};
        \node [blockb,thick, left =\hdist of l22]               (l21) {$\tfrac{\dfstate}{\absvar_i}$};
        \node [blocka, right =\hdist of l23]              (l24) {$\pdfrac{\optcrit}{\dmpos}$};
        \node [blocka, right =\hdist of l24]              (l25) {$\tfrac{\dmpos}{\absvar_i}$};
        \node [above of = l21]                            (l21u) {};
        \node [below of = l21]                            (l21o) {};
        \node [below of = l22]                            (l22o) {};
        \node [below of = l23]                            (l23o) {};
        \node [below of = l24]                            (l24o) {};
        \node [below of = l25]                            (l25o) {};
        
%        %level-3
%        \node [blocka, below of=l23o]                      (l33) {$\pdfrac{\dresidual}{\dfstate}$};
%        \node [blockb, left =\hdist of l33]               (l32) {$\tfrac{\dresidual}{\absvar}$};
%        \node [blocka, left =\hdist of l32]               (l31) {$\pdfrac{\dresidual}{\dmpos}$};
%        \node [blocka, right =\hdist of l33]              (l34) {$\tfrac{\dmpos}{\absvar_i}$};
%        %\node [blocka, right =\hdist of l34]              (l35) {l35};
%        \node [below of = l31]                            (l31o) {};
%        \node [below of = l32]                            (l32o) {};
%        \node [below of = l33]                            (l33o) {};
%        \node [below of = l34]                            (l34o) {};
        %\node [below of = l35]                            (l35o) {};
        
%        %level-4
%        \node [blockb, below of=l33o]                     (l43) {$\pdfrac{\dresidual}{\absvar}$};
%        \node [blocka, left =\hdist of l43]               (l42) {$\pdfrac{\dresidual}{\dfstate^{\star}}$};
%        \node [blocka, left =\hdist of l42]               (l41) {$\pdfrac{\dfstate^{\star}}{\absvar}$};
%        \node [blocka, right =\hdist of l43]              (l44) {$\pdfrac{\dfstateprim^g}{\dfstateprim^a}$};
%        %\node [blocka, right =\hdist of l44]             (l45) {$\pdfrac{}{}$};
%        \node [below of = l41]                            (l41o) {};
%        \node [below of = l42]                            (l42o) {};
%        \node [below of = l43]                            (l43o) {};
%        \node [below of = l44]                            (l44o) {};
%        %\node [below of = l45]                            (l45o) {};
        
%        %level-5
%        \node [blocka, below of=l43o]                      (l53) {$\pdfrac{\dfstateprim^g}{\absvar}$};
%        \node [blocka, left =\hdist of l53]               (l52) {$\pdfrac{\dresidual}{\dmpos}$};
%        %\node [blocka, left =\hdist of l52]               (l51) {l51};
%        \node [blocka, right =\hdist of l53]              (l54) {$\pdfrac{\dmpos}{\absvar}$};
%        %\node [blocka, right =\hdist of l54]              (l55) {l55};
%        
  
        %thick lines      
        \draw[-,very thick] (l11) -- (l11o);
        \draw[-,very thick] (l11o) -| (l21);
        \draw[-,very thick] (l21u) -| (l11);
        
        \draw[-,very thick] (l21) |- (l22o);
        \draw[-,very thick] (l21o) -| (l32);
        
%        \draw[-,very thick] (l32) |- (l33o);
%        \draw[-,very thick] (l32o) -| (l43);
        
        %thin lines
        \draw[-] (l11o) -| (l22);
        \draw[-] (l11o) -| (l23);
        \draw[-] (l11o) -| (l24);
        \draw[-] (l11o) -| (l25);
%        \draw[-] (l21o) -- (l31);
%        \draw[-] (l21o) -| (l33);
%        \draw[-] (l21o) -| (l34);
%        \draw[-] (l41) |- (l34o);
%        \draw[-] (l44) |- (l31o);
%        \draw[-] (l43) -- (l53);
%        \draw[-] (l52) |- (l44o);
%        \draw[-] (l42o) -| (l54);
        
        
        %draw dashed lines
        \draw[gray,dashed] (l22) -- (l22o) node[midway] (l22){};
        \draw[gray,dashed] (l23) -- (l23o) node[midway] (l23){};
        \draw[gray,dashed] (l24) -- (l24o) node[midway] (l24){};
        \draw[gray,dashed] (l25) -- (l25o) node[midway] (l25){};
        
%        \draw[gray,dashed] (l31) -- (l31o) node[midway] (l31){};
%        \draw[gray,dashed] (l33) -- (l33o) node[midway] (l33){};
%        \draw[gray,dashed] (l34) -- (l34o) node[midway] (l34){};
%        
%        \draw[gray,dashed] (l41) -- (l41o) node[midway] (l41){};
%        \draw[gray,dashed] (l42) -- (l42o) node[midway] (l42){};
%        \draw[gray,dashed] (l44) -- (l44o) node[midway] (l44){};
\end{tikzpicture}
\end{frame}


%------------------------------------------------------------------------------

\begin{frame}
\frametitle{Derivation of $\pdfrac{\dfstate}{\absvar}$}

\begin{itemize}


\only<1->{\item Consider the fluid equations at equilibrium
\begin{align*}
\cancelto{0}{\pdfrac{\bar{\dfstate_i}}{t}} +
\underbrace{
  \underbrace{\sum_{j \in \vertexset(i)} \fluxesnum_{ij}(\dfstate_{ij},\dfstate_{ji},\wnormal_{ij})}_{\dresidual^i} -
  \underbrace{\sum_{T_i \in \elementset(i)} \int_{T_j} \difftensor \nabla \dfstate \nabla \phi_j dx}_{\dresidual^v}      }_{\dresidual} =
\vec{0}
\end{align*}}

\only<2->{\item Therefore
\def\DdresidualBYabsvarI{ \tfrac{\dresidual}{\absvar_i} }
\def\PdresidualBYabsvarI{ \pdfrac{\dresidual}{\absvar_i} }
\def\PdresidualBYdfstate{ \pdfrac{\dresidual}{\dfstate}  }
\def\DdfstateBYabsvarI  { \tfrac{\dfstate}{\absvar_i}   }
\def\PdresidualBYdmms   { \pdfrac{\dresidual}{\dmpos}     }
\def\DdmmsBYabsvarI     { \tfrac{\dmpos}{\absvar_i}      }
\begin{align*}
\DdresidualBYabsvarI=\vec{0}=
\PdresidualBYabsvarI                      +
\PdresidualBYdfstate    \DdfstateBYabsvarI +
\PdresidualBYdmms       \DdmmsBYabsvarI
\end{align*}}

\only<3->{\item Which leads to
\begin{align*}
\PdresidualBYdfstate \displaystyle\DdfstateBYabsvarI=
-\DdresidualBYabsvarI
-\PdresidualBYdmms   \DdmmsBYabsvarI
\end{align*}}

\end{itemize}
\end{frame}

%------------------------------------------------------------------------------


\def\DdresidualBYabsvarI{ \tfrac{\dresidual}{\absvar_i} }
\def\PdresidualBYabsvarI{ \pdfrac{\dresidual}{\absvar_i} }
\def\PdresidualBYdfstate{ \pdfrac{\dresidual}{\dfstate}  }
\def\DdfstateBYabsvarI  { \tfrac{\dfstate}{\absvar_i}   }
\def\PdresidualBYdmms   { \pdfrac{\dresidual}{\dmpos}     }
\def\DdmmsBYabsvarI     { \tfrac{\dmpos}{\absvar_i}      }
%\everymath{\scriptstyle}
\begin{frame}
\frametitle{Derivation of $\pdfrac{\dfstate}{\absvar}$}
  \begin{itemize}
  
  \item{The total derivative of the fluid state thus gives}
		\begin{align*}
		\tfrac{\dfstate}{\absvar}=
		\inv{\left[\PdresidualBYdfstate\bigg\rvert_{\fstate_0}\right]}
		\left(
		  \PdresidualBYabsvarI\bigg\rvert_{\fstate_0} +
		  \begin{bmatrix}
		    \alpha\pdfrac{\dresidual}{\dmms_\Omega}\bigg\rvert_{\dfstate_0}~
		    \pdfrac{\dresidual}{\dmms_\Gamma}\bigg\rvert_{\dfstate_0}
		  \end{bmatrix}
		  \begin{bmatrix}
		    \alpha \inv{\fic{\stiffmat}_{\Omega\Omega}} \fic{\stiffmat}_{\Omega\Gamma} \\
		    \eye
		  \end{bmatrix}
		  \tfrac{\dmms_\Gamma}{\absvar_i}
		\right)
		\end{align*}  
  
  
	\item Which leads to the following, final equation for the sensitivities
		\begin{align*}
		\tfrac{\optcrit_j}{\absvar_i}\bigg\rvert_{\dfstate_0} &=
		-\tfrac{\optcrit_j}{\fstate}\bigg\rvert_{\dfstate_0}
		\inv{\left[\hle{neutral_0}{\PdresidualBYdfstate}\bigg\rvert_{\fstate_0}\right]} \\
		&\left(
		  \hle{neutral_1}{\PdresidualBYabsvarI}\bigg\rvert_{\fstate_0} +
		  \begin{bmatrix}
		    \alpha\pdfrac{\dresidual}{\dmms_\Omega}\bigg\rvert_{\dfstate_0}~
		    \pdfrac{\dresidual}{\dmms_\Gamma}\bigg\rvert_{\dfstate_0}
		  \end{bmatrix}
		  \begin{bmatrix}
		    \alpha \inv{\fic{\stiffmat}_{\Omega\Omega}} \fic{\stiffmat}_{\Omega\Gamma} \\
		    \eye
		  \end{bmatrix}
		  \tfrac{\dmms_\Gamma}{\absvar_i}
		\right)\\
		\alpha&=
		\begin{cases}
		  1\text{  in ALE framework}\\
		  0\text{  in Embedded framework}
		\end{cases}
		\end{align*}
	\end{itemize}
	\only<1->{\textbf{$\rightarrow$ We only look into these terms}}
\end{frame}
%\everymath{\displaystyle}

%------------------------------------------------------------------------------
\begin{frame}
\def\DdresidualBYabsvarI{ \tfrac{\dresidual}{\absvar_i} }
\def\PdresidualBYabsvarI{ \pdfrac{\dresidual}{\absvar_i} }
\def\PdresidualBYdfstate{ \pdfrac{\dresidual}{\dfstate}  }
\def\DdfstateBYabsvarI  { \tfrac{\dfstate}{\absvar_i}   }
\def\PdresidualBYdmms   { \pdfrac{\dresidual}{\dmpos}     }
\def\DdmmsBYabsvarI     { \tfrac{\dmpos}{\absvar_i}      }
\frametitle{Derivation of $\pdfrac{\dfstate}{\absvar}$}
\framesubtitle{Direct and Adjoint method}
\begin{itemize}
	\item{Matrix-Matrix-Matrix product}
	\begin{align*}
		\DdfstateBYabsvarI=-\inv{\PdresidualBYdfstate}
		\hle{neutral_0}{\DdresidualBYabsvarI}
		\only<1>{-\inv{\hle{neutral_0}{\PdresidualBYdfstate}}\PdresidualBYdmms\DdmmsBYabsvarI}
		\only<2->{-\underbrace{\inv{\hle{neutral_0}{\PdresidualBYdfstate}}\PdresidualBYdmms\DdmmsBYabsvarI}_{\dmat{A}\dmat{B}\dmat{C}}}
	\end{align*}
	\item{Two different ways to do the product}
	\begin{itemize}
		\item{Direct: $\dmat{A}\dmat{B}\dmat{C}$~~$\order{n_{eq}^2n_{\absvars}+n_{\optcrits}n_{eq}n_{\absvars}}$}
		\item{Adjoint: $\left[\dmat{C}^T(\dmat{A}\dmat{B})\right]^T$~~$\order{n_{eq}^2n_{\optcrits}+n_{\optcrits}n_{eq}n_{\absvars}}$}
		\begin{align*}
		&n_{eq}\rightarrow&\text{number of equations}\\
		&n_{\absvars}\rightarrow&\text{number of abstract variables}\\
		&n_{\optcrits}\rightarrow&\text{number of optimization criteria}
		\end{align*}
	\end{itemize}

\end{itemize}
\only<3->{\textbf{We only look into these terms}}
\end{frame}





%------------------------------------------------------------------------------


\begin{frame}
\frametitle{Sensitivity derivation - chain rule}
\framesubtitle{$\tfrac{\dfstate}{\absvar_i}$}
\centering
\begin{tikzpicture}[node distance = 0.6cm, auto]
        \def\hdist{0.7cm}
        \node [blockb]                                      (l11) {$\pdfrac{\optcrit}{\absvar}$};
        \node [below of = l11]                              (l11o) {};
        
        %level-2
        \node [blocka, below of=l11o]                      (l23) {$\pdfrac{\optcrit_j}{\absvar_i}$};
        \node [blocka, left =\hdist of l23]               (l22) {$\pdfrac{\optcrit_j}{\dfstate}$};
        \node [blockb, left =\hdist of l22]               (l21) {$\tfrac{\dfstate}{\absvar_i}$};
        \node [blocka, right =\hdist of l23]              (l24) {$\pdfrac{\optcrit}{\dmpos}$};
        \node [blocka, right =\hdist of l24]              (l25) {$\tfrac{\dmpos}{\absvar_i}$};
        \node [above of = l21]                            (l21u) {};
        \node [below of = l21]                            (l21o) {};
        \node [below of = l22]                            (l22o) {};
        \node [below of = l23]                            (l23o) {};
        \node [below of = l24]                            (l24o) {};
        \node [below of = l25]                            (l25o) {};
        
        %level-3
        \node [blockb, below of=l23o]                      (l33) {$\pdfrac{\dresidual}{\dfstate}$};
        \node [blockb,thick, left =\hdist of l33]               (l32) {$\tfrac{\dresidual}{\absvar}$};
        \node [blocka, left =\hdist of l32]               (l31) {$\pdfrac{\dresidual}{\dmpos}$};
        \node [blocka, right =\hdist of l33]              (l34) {$\tfrac{\dmpos}{\absvar_i}$};
        %\node [blocka, right =\hdist of l34]              (l35) {l35};
        \node [below of = l31]                            (l31o) {};
        \node [below of = l32]                            (l32o) {};
        \node [below of = l33]                            (l33o) {};
        \node [below of = l34]                            (l34o) {};
       % \node [below of = l35]                            (l35o) {};
        
%        %level-4
%        \node [blockb, below of=l33o]                     (l43) {$\pdfrac{\dresidual}{\absvar}$};
%        \node [blocka, left =\hdist of l43]               (l42) {$\pdfrac{\dresidual}{\dfstate^{\star}}$};
%        \node [blocka, left =\hdist of l42]               (l41) {$\pdfrac{\dfstate^{\star}}{\absvar}$};
%        \node [blocka, right =\hdist of l43]              (l44) {$\pdfrac{\dfstateprim^g}{\dfstateprim^a}$};
%        %\node [blocka, right =\hdist of l44]             (l45) {$\pdfrac{}{}$};
%        \node [below of = l41]                            (l41o) {};
%        \node [below of = l42]                            (l42o) {};
%        \node [below of = l43]                            (l43o) {};
%        \node [below of = l44]                            (l44o) {};
%        %\node [below of = l45]                            (l45o) {};
        
%        %level-5
%        \node [blocka, below of=l43o]                      (l53) {$\pdfrac{\dfstateprim^g}{\absvar}$};
%        \node [blocka, left =\hdist of l53]               (l52) {$\pdfrac{\dresidual}{\dmpos}$};
%        %\node [blocka, left =\hdist of l52]               (l51) {l51};
%        \node [blocka, right =\hdist of l53]              (l54) {$\pdfrac{\dmpos}{\absvar}$};
%        %\node [blocka, right =\hdist of l54]              (l55) {l55};
%        
  
        %thick lines      
        \draw[-,very thick] (l11) -- (l11o);
        \draw[-,very thick] (l11o) -| (l21);
        \draw[-,very thick] (l21u) -| (l11);
        
        \draw[-,very thick] (l21) |- (l22o);
        \draw[-,very thick] (l21o) -| (l32);
        
%        \draw[-,very thick] (l32) |- (l33o);
%        \draw[-,very thick] (l32o) -| (l43);
        
        %thin lines
        \draw[-] (l11o) -| (l22);
        \draw[-] (l11o) -| (l23);
        \draw[-] (l11o) -| (l24);
        \draw[-] (l11o) -| (l25);
%        \draw[-] (l21o) -- (l31);
%        \draw[-] (l21o) -| (l33);
%        \draw[-] (l21o) -| (l34);
%        \draw[-] (l41) |- (l34o);
%        \draw[-] (l44) |- (l31o);
%        \draw[-] (l43) -- (l53);
%        \draw[-] (l52) |- (l44o);
%        \draw[-] (l42o) -| (l54);
        
        
        %draw dashed lines
        \draw[gray,dashed] (l22) -- (l22o) node[midway] (l22){};
        \draw[gray,dashed] (l23) -- (l23o) node[midway] (l23){};
        \draw[gray,dashed] (l24) -- (l24o) node[midway] (l24){};
        \draw[gray,dashed] (l25) -- (l25o) node[midway] (l25){};
        
%        \draw[gray,dashed] (l31) -- (l31o) node[midway] (l31){};
%        \draw[gray,dashed] (l33) -- (l33o) node[midway] (l33){};
%        \draw[gray,dashed] (l34) -- (l34o) node[midway] (l34){};
%        
%        \draw[gray,dashed] (l41) -- (l41o) node[midway] (l41){};
%        \draw[gray,dashed] (l42) -- (l42o) node[midway] (l42){};
%        \draw[gray,dashed] (l44) -- (l44o) node[midway] (l44){};
\end{tikzpicture}
\end{frame}



%------------------------------------------------------------------------------


\begin{frame}
\frametitle{Derivation of $\pdfrac{\dresidual}{\dfstate}$ }
\begin{itemize}
\item{Also known as fluid Jacobian}
\begin{align*}
    \frac{\partial \dresidual^{c,i}_{ij}}{\partial \dfstate_k} = 
    {\color{primary_0}{\frac{\partial \dresidual^{c,i}_{ij}}{\partial \dfstateprim_{ij}^\star}}} \,
    {\color{neutral_1}{\frac{\partial \dfstateprim_{ij}^\star}{\partial \dfstateprim_k}}} \,
    \frac{\partial \dfstateprim_k}{\partial \dfstate_k} +
    {\color{primary_0}{\frac{\partial \dresidual^{c,i}_{ij}}{\partial \dfstateprim_{ij}}}} \,
    {\color{neutral_2}{\frac{\partial \dfstateprim_{ij}}{\partial \dfstateprim_k}}} \,
    \frac{\partial \dfstateprim_k}{\partial \dfstate_k} +
    \underbrace{\pdfrac{\dresidual^{c,i}_{ij}}{\dmpos}\pdfrac{\dmpos}{\normal_{ij}}}_{=\vec{0}\text{ for embedded}}
\end{align*}

\begin{center}
	\begin{itemize}
	  \item {\color{primary_0} {Analytical Jacobian of the (Roe's) centering flux} }
	  \item {\color{neutral_1} {Analytical derivative of the solution of the 1D half-Riemann problem}}
	  \item {\color{neutral_2} {Analytical derivative of the MUSCL reconstruction and limitation}}
	\end{itemize}
\end{center}

\end{itemize}


\only<2->{
\begin{itemize}
  \item some things to consider
  \begin{itemize}
	  \item equation of state
	  \item flux limiters
	  \item \dots
	\end{itemize}
\end{itemize}
}


\only<3>{$\rightarrow$ \textbf{I don't go into any more detail here!}}
\end{frame}

%------------------------------------------------------------------------------
%\everymath{\scriptstyle}
%\begin{frame}
%	The interface component is determined by the structure. Having obtained this one, the interior component can be computed by solving an auxiliary, fictitious Dirichlet problem:
%	\begin{align*}
%	\tfrac{\mms_\Omega}{\absvar_i}=-\left[\inv{\fic{\stiffmat}_{\Omega\Omega}} \fic{\stiffmat}_{\Omega\Gamma}\right] \tfrac{\mpos_\Gamma}{\absvar_i}
%	\end{align*}
%	\begin{align*}
%	\tfrac{\optcrit_j}{\absvar_i}\bigg\rvert_{\dfstate_0} &=
%	-\tfrac{\optcrit_j}{\fstate}\bigg\rvert_{\dfstate_0}
%	\inv{\left[\PdresidualBYdfstate\bigg\rvert_{\fstate_0}\right]}
%	\left(
%	  \hle{neutral_1}{\PdresidualBYabsvarI\bigg\rvert_{\fstate_0} } +
%	  \begin{bmatrix}
%	    \alpha\pdfrac{\dresidual}{\dmms_\Omega}\bigg\rvert_{\dfstate_0}~
%	    \pdfrac{\dresidual}{\dmms_\Gamma}\bigg\rvert_{\dfstate_0}
%	  \end{bmatrix}
%	  \underbrace{\begin{bmatrix}
%	    \alpha \inv{\fic{\stiffmat}_{\Omega\Omega}} \fic{\stiffmat}_{\Omega\Gamma} \nonumber\\
%	    \eye
%	  \end{bmatrix}
%	  \underbrace{\tfrac{\dmms_\Gamma}{\absvar_i}}_{\text{SDESIGN}}   }_{\text{ALE mesh motion}}
%	\right)\\
%	\alpha&=
%	\begin{cases}
%	  1\text{  in ALE framework}\\
%	  0\text{  in Embedded framework}
%	\end{cases}
%	\end{align*}
%\end{frame}
%\everymath{\displaystyle}
%------------------------------------------------------------------------------

\begin{frame}
\frametitle{Sensitivity derivation - chain rule}
\framesubtitle{$\tfrac{\dfstate}{\absvar_i}$}
\centering
\begin{tikzpicture}[node distance = 0.6cm, auto]
        \def\hdist{0.7cm}
        \node [blockb]                                      (l11) {$\pdfrac{\optcrit}{\absvar}$};
        \node [below of = l11]                              (l11o) {};
        
        %level-2
        \node [blocka, below of=l11o]                      (l23) {$\pdfrac{\optcrit_j}{\absvar_i}$};
        \node [blocka, left =\hdist of l23]               (l22) {$\pdfrac{\optcrit_j}{\dfstate}$};
        \node [blockb, left =\hdist of l22]               (l21) {$\tfrac{\dfstate}{\absvar_i}$};
        \node [blocka, right =\hdist of l23]              (l24) {$\pdfrac{\optcrit}{\dmpos}$};
        \node [blocka, right =\hdist of l24]              (l25) {$\tfrac{\dmpos}{\absvar_i}$};
        \node [above of = l21]                            (l21u) {};
        \node [below of = l21]                            (l21o) {};
        \node [below of = l22]                            (l22o) {};
        \node [below of = l23]                            (l23o) {};
        \node [below of = l24]                            (l24o) {};
        \node [below of = l25]                            (l25o) {};
        
        %level-3
        \node [blockb, below of=l23o]                      (l33) {$\pdfrac{\dresidual}{\dfstate}$};
        \node [blockb,thick, left =\hdist of l33]               (l32) {$\tfrac{\dresidual}{\absvar}$};
        \node [blocka, left =\hdist of l32]               (l31) {$\pdfrac{\dresidual}{\dmpos}$};
        \node [blocka, right =\hdist of l33]              (l34) {$\tfrac{\dmpos}{\absvar_i}$};
        %\node [blocka, right =\hdist of l34]              (l35) {l35};
        \node [below of = l31]                            (l31o) {};
        \node [below of = l32]                            (l32o) {};
        \node [below of = l33]                            (l33o) {};
        \node [below of = l34]                            (l34o) {};
       % \node [below of = l35]                            (l35o) {};

        %thick lines      
        \draw[-,very thick] (l11) -- (l11o);
        \draw[-,very thick] (l11o) -| (l21);
        \draw[-,very thick] (l21u) -| (l11);
        
        \draw[-,very thick] (l21) |- (l22o);
        \draw[-,very thick] (l21o) -| (l32);

        %thin lines
        \draw[-] (l11o) -| (l22);
        \draw[-] (l11o) -| (l23);
        \draw[-] (l11o) -| (l24);
        \draw[-] (l11o) -| (l25);
        
        
        %draw dashed lines
        \draw[gray,dashed] (l22) -- (l22o) node[midway] (l22){};
        \draw[gray,dashed] (l23) -- (l23o) node[midway] (l23){};
        \draw[gray,dashed] (l24) -- (l24o) node[midway] (l24){};
        \draw[gray,dashed] (l25) -- (l25o) node[midway] (l25){};

\end{tikzpicture}
\end{frame}

%------------------------------------------------------------------------------

\begin{frame}
\frametitle{Analytic derivatives}
\framesubtitle{$\pdfrac{\dresidual}{\absvar_i}$}

\begin{itemize}
\item{Remember}
\begin{align*}
\dresidual=\dresidual^i+\dresidual^v
\end{align*}
\item{Approach}
	\begin{itemize}
		\item Separate treatment of inviscid and viscous contribution
		\item Re-use information from the intersector, obtained by FIVER, whenever possible
	\end{itemize}
\item Inviscid part

\end{itemize}

\begin{align*}
& \dresidual^{c,i}_{ij} = \fluxesnum^i_{ij}(\dfstateprim_{ij},\dfstateprim^{*}_{ij}(\absvar),\normal_{ij}) \\
& \pdfrac{\dresidual^{c,i}_{ij}}{\absvar}=\pdfrac{\dresidual^{c,i}_{ij}}{\dfstate^{\star}_{ij}}\pdfrac{\dfstate^{\star}_{ij}}{\absvar}
\end{align*}

\end{frame}

%------------------------------------------------------------------------------


\begin{frame}
\frametitle{Analytic derivatives}
\framesubtitle{$\pdfrac{\dresidual}{\absvar_i}$}

\begin{itemize}
\item Diffusive part
\end{itemize}

\begin{align*}
\dresidual_i^v=-\sum_{T_i \in \elementset(i)} \sum_{i=1}^{n_g} 
w_i \prim{\difftensor} \nabla \prim{\dfstate}(\dmpos_i) \nabla \phi_j(\dmpos_i) dx
\end{align*}
\begin{align*}
    & \pdfrac{\dresidual^v(\absvars,\dfstateprim^a(\absvars),\dfstateprim^g(\dfstateprim^a(\absvars)),\mpos(\absvars))}{\absvars}=\\
    & \underbrace{\pdfrac{\dresidual^v}{\dfstateprim^a}\pdfrac{\dfstateprim^a}{\absvars}}_{\substack{\text{can be re-used from ALE } \\ \text{after the ghost-point population}}}+
    \pdfrac{\dresidual^v}{\dfstateprim^g}\cdot
    \overbrace{\pdfrac{\dfstateprim^g}{\dfstateprim^a}}^{\substack{\text{obtained during the}\\ \text{population process} }} \pdfrac{\dfstateprim^a}{\absvars} \nonumber
    +
    \underbrace{\pdfrac{\dresidual}{\dmpos}\pdfrac{\dmpos}{\absvars}}_{=\vec{0}\text{ for embedded}}
\end{align*}
\end{frame}


\begin{frame}
\frametitle{Sensitivity derivation - chain rule}
\framesubtitle{$\tfrac{\dresidual}{\absvar}$}
\centering
\begin{tikzpicture}[node distance = 0.6cm, auto]
        \def\hdist{0.7cm}
        \node [blockb]                                      (l11) {$\pdfrac{\optcrit}{\absvar}$};
        \node [below of = l11]                              (l11o) {};
        
        %level-2
        \node [blocka, below of=l11o]                      (l23) {$\pdfrac{\optcrit_j}{\absvar_i}$};
        \node [blocka, left =\hdist of l23]               (l22) {$\pdfrac{\optcrit_j}{\dfstate}$};
        \node [blockb, left =\hdist of l22]               (l21) {$\tfrac{\dfstate}{\absvar_i}$};
        \node [blocka, right =\hdist of l23]              (l24) {$\pdfrac{\optcrit}{\dmpos}$};
        \node [blocka, right =\hdist of l24]              (l25) {$\tfrac{\dmpos}{\absvar_i}$};
        \node [above of = l21]                            (l21u) {};
        \node [below of = l21]                            (l21o) {};
        \node [below of = l22]                            (l22o) {};
        \node [below of = l23]                            (l23o) {};
        \node [below of = l24]                            (l24o) {};
        \node [below of = l25]                            (l25o) {};
        
        %level-3
        \node [blocka, below of=l23o]                      (l33) {$\pdfrac{\dresidual}{\dfstate}$};
        \node [blockb, left =\hdist of l33]               (l32) {$\tfrac{\dresidual}{\absvar}$};
        \node [blocka, left =\hdist of l32]               (l31) {$\pdfrac{\dresidual}{\dmpos}$};
        \node [blocka, right =\hdist of l33]              (l34) {$\tfrac{\dmpos}{\absvar_i}$};
        %\node [blocka, right =\hdist of l34]              (l35) {l35};
        \node [below of = l31]                            (l31o) {};
        \node [below of = l32]                            (l32o) {};
        \node [below of = l33]                            (l33o) {};
        \node [below of = l34]                            (l34o) {};
        %\node [below of = l35]                            (l35o) {};
        
        %level-4
        \node [blockb,thick, below of=l33o]                     (l43) {$\pdfrac{\dresidual}{\absvar}$};
        \node [blocka, left =\hdist of l43]               (l42) {$\pdfrac{\dresidual}{\dfstate^{\star}}$};
        \node [blocka, left =\hdist of l42]               (l41) {$\pdfrac{\dfstate^{\star}}{\absvar}$};
        \node [blocka, right =\hdist of l43]              (l44) {$\pdfrac{\dfstateprim^g}{\dfstateprim^a}$};
        %\node [blocka, right =\hdist of l44]             (l45) {$\pdfrac{}{}$};
        \node [below of = l41]                            (l41o) {};
        \node [below of = l42]                            (l42o) {};
        \node [below of = l43]                            (l43o) {};
        \node [below of = l44]                            (l44o) {};
        %\node [below of = l45]                            (l45o) {};
        
%        %level-5
%        \node [blocka, below of=l43o]                      (l53) {$\pdfrac{\dfstateprim^g}{\absvar}$};
%        \node [blocka, left =\hdist of l53]               (l52) {$\pdfrac{\dresidual}{\dmpos}$};
%        %\node [blocka, left =\hdist of l52]               (l51) {l51};
%        \node [blocka, right =\hdist of l53]              (l54) {$\pdfrac{\dmpos}{\absvar}$};
%        %\node [blocka, right =\hdist of l54]              (l55) {l55};
%        
  
        %thick lines      
        \draw[-,very thick] (l11) -- (l11o);
        \draw[-,very thick] (l11o) -| (l21);
        \draw[-,very thick] (l21u) -| (l11);
        
        \draw[-,very thick] (l21) |- (l22o);
        \draw[-,very thick] (l21o) -| (l32);
        
        \draw[-,very thick] (l32) |- (l33o);
        \draw[-,very thick] (l32o) -| (l43);
        
        %thin lines
        \draw[-] (l11o) -| (l22);
        \draw[-] (l11o) -| (l23);
        \draw[-] (l11o) -| (l24);
        \draw[-] (l11o) -| (l25);
        \draw[-] (l21o) -- (l31);
        \draw[-] (l21o) -| (l33);
        \draw[-] (l21o) -| (l34);
        \draw[-] (l41) |- (l34o);
        \draw[-] (l44) |- (l31o);
%        \draw[-] (l43) -- (l53);
%        \draw[-] (l52) |- (l44o);
%        \draw[-] (l42o) -| (l54);
        
        
        %draw dashed lines
        \draw[gray,dashed] (l22) -- (l22o) node[midway] (l22){};
        \draw[gray,dashed] (l23) -- (l23o) node[midway] (l23){};
        \draw[gray,dashed] (l24) -- (l24o) node[midway] (l24){};
        \draw[gray,dashed] (l25) -- (l25o) node[midway] (l25){};
        
        \draw[gray,dashed] (l31) -- (l31o) node[midway] (l31){};
        \draw[gray,dashed] (l33) -- (l33o) node[midway] (l33){};
        \draw[gray,dashed] (l34) -- (l34o) node[midway] (l34){};
        
%        \draw[gray,dashed] (l41) -- (l41o) node[midway] (l41){};
%        \draw[gray,dashed] (l42) -- (l42o) node[midway] (l42){};
%        \draw[gray,dashed] (l44) -- (l44o) node[midway] (l44){};
\end{tikzpicture}
\end{frame}



\begin{frame}
\frametitle{Sensitivity derivation - chain rule}
\framesubtitle{$\pdfrac{\dresidual}{\absvar}$}
\centering
\begin{tikzpicture}[node distance = 0.6cm, auto]
        \def\hdist{0.7cm}
        \node [blockb]                                      (l11) {$\pdfrac{\optcrit}{\absvar}$};
        \node [below of = l11]                              (l11o) {};
        
        %level-2
        \node [blocka, below of=l11o]                      (l23) {$\pdfrac{\optcrit_j}{\absvar_i}$};
        \node [blocka, left =\hdist of l23]               (l22) {$\pdfrac{\optcrit_j}{\dfstate}$};
        \node [blockb, left =\hdist of l22]               (l21) {$\tfrac{\dfstate}{\absvar_i}$};
        \node [blocka, right =\hdist of l23]              (l24) {$\pdfrac{\optcrit}{\dmpos}$};
        \node [blocka, right =\hdist of l24]              (l25) {$\tfrac{\dmpos}{\absvar_i}$};
        \node [above of = l21]                            (l21u) {};
        \node [below of = l21]                            (l21o) {};
        \node [below of = l22]                            (l22o) {};
        \node [below of = l23]                            (l23o) {};
        \node [below of = l24]                            (l24o) {};
        \node [below of = l25]                            (l25o) {};
        
        %level-3
        \node [blocka, below of=l23o]                      (l33) {$\pdfrac{\dresidual}{\dfstate}$};
        \node [blockb, left =\hdist of l33]               (l32) {$\tfrac{\dresidual}{\absvar}$};
        \node [blocka, left =\hdist of l32]               (l31) {$\pdfrac{\dresidual}{\dmpos}$};
        \node [blocka, right =\hdist of l33]              (l34) {$\tfrac{\dmpos}{\absvar_i}$};
        %\node [blocka, right =\hdist of l34]              (l35) {l35};
        \node [below of = l31]                            (l31o) {};
        \node [below of = l32]                            (l32o) {};
        \node [below of = l33]                            (l33o) {};
        \node [below of = l34]                            (l34o) {};
        %\node [below of = l35]                            (l35o) {};
        
        %level-4
        \node [blockb, below of=l33o]                     (l43) {$\pdfrac{\dresidual}{\absvar}$};
        \node [blocka, left =\hdist of l43]               (l42) {$\pdfrac{\dresidual}{\dfstate^{\star}}$};
        \node [blocka, left =\hdist of l42]               (l41) {$\pdfrac{\dfstate^{\star}}{\absvar}$};
        \node [blocka, right =\hdist of l43]              (l44) {$\pdfrac{\dfstateprim^g}{\dfstateprim^a}$};
        %\node [blocka, right =\hdist of l44]             (l45) {$\pdfrac{}{}$};
        \node [below of = l41]                            (l41o) {};
        \node [below of = l42]                            (l42o) {};
        \node [below of = l43]                            (l43o) {};
        \node [below of = l44]                            (l44o) {};
        %\node [below of = l45]                            (l45o) {};
        
        %level-5
        \node [blocka, below of=l43o]                     (l53) {$\pdfrac{\dfstateprim^g}{\absvar}$};
        \node [blocka, left =\hdist of l53]               (l52) {$\pdfrac{\dresidual}{\dmpos}$};
        \node [blocka, right =\hdist of l53]              (l54) {$\pdfrac{\dmpos}{\absvar}$}; 
  
        %thick lines      
        \draw[-,very thick] (l11) -- (l11o);
        \draw[-,very thick] (l11o) -| (l21);
        \draw[-,very thick] (l21u) -| (l11);
        
        \draw[-,very thick] (l21) |- (l22o);
        \draw[-,very thick] (l21o) -| (l32);
        
        \draw[-,very thick] (l32) |- (l33o);
        \draw[-,very thick] (l32o) -| (l43);
        
        %thin lines
        \draw[-] (l11o) -| (l22);
        \draw[-] (l11o) -| (l23);
        \draw[-] (l11o) -| (l24);
        \draw[-] (l11o) -| (l25);
        \draw[-] (l21o) -- (l31);
        \draw[-] (l21o) -| (l33);
        \draw[-] (l21o) -| (l34);
        \draw[-] (l41) |- (l34o);
        \draw[-] (l44) |- (l31o);
        \draw[-] (l43) -- (l53);
        \draw[-] (l52) |- (l44o);
        \draw[-] (l42o) -| (l54);
        
        
        %draw dashed lines
        \draw[gray,dashed] (l22) -- (l22o) node[midway] (l22){};
        \draw[gray,dashed] (l23) -- (l23o) node[midway] (l23){};
        \draw[gray,dashed] (l24) -- (l24o) node[midway] (l24){};
        \draw[gray,dashed] (l25) -- (l25o) node[midway] (l25){};
        
        \draw[gray,dashed] (l31) -- (l31o) node[midway] (l31){};
        \draw[gray,dashed] (l33) -- (l33o) node[midway] (l33){};
        \draw[gray,dashed] (l34) -- (l34o) node[midway] (l34){};
        
        \draw[gray,dashed] (l41) -- (l41o) node[midway] (l41){};
        \draw[gray,dashed] (l42) -- (l42o) node[midway] (l42){};
        \draw[gray,dashed] (l44) -- (l44o) node[midway] (l44){};
\end{tikzpicture}
\end{frame}